<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>The Martin Guitar Selector</title>
  <meta name="description" content="The Martin Guitar Selector">
  <meta name="author" content="Tamas Kenez">

  <link rel="stylesheet" href="css/styles.css">
  <script src="res/guitardb.js"></script>
  <style>
    .rotate90 {
      -webkit-transform: rotate(90deg);
      -moz-transform: rotate(90deg);
      -o-transform: rotate(90deg);
      -ms-transform: rotate(90deg);
      transform: rotate(90deg);
    }
    .choice_key {
      cursor: default;
      display: block;
      height: 20px;
      white-space: nowrap;
      -webkit-border-radius: 3px;
      border-radius: 3px;
    }
    .choice {
      background-color: #f5f5f5;
      border: 1px solid #d9d9d9;
      cursor: default;
      display: block;
      height: 20px;
      white-space: nowrap;
      -webkit-border-radius: 3px;
      border-radius: 3px;
      color: #808080;
    }
    .choice:hover {
      border: 1px solid #898989;
    }
    .activeChoice {
      background-color: #f5f585;
      border: 1px solid #d9d989;
      cursor: default;
      display: block;
      height: 20px;
      white-space: nowrap;
      -webkit-border-radius: 3px;
      border-radius: 3px;
    }
    .activeChoice:hover {
      border: 1px solid #898989;
    }
  </style>
</head>

<body>
  <div>
    <table>
      <tr id='tr_productGroupChoice'>
        <td><span class="choice_key">Product Group: </span>
    </table>
  </div>
  <div>
    <table>
      <tr id='tr_seriesChoice'>
        <td><span class="choice_key">Series: </span>
    </table>
  </div>
  <div>
    <table>
      <tr id='tr_simplifiedBodySizeChoice'>
        <td><span class="choice_key">Body Size: </span>
    </table>
  </div>
  <div id='div_data_display'>Table here</div>
  <script>
    const PRODUCT_GROUP_CHOICE_SET = ['6-String', '12-String', 'Backpacker', 'Ukulele']
    const SERIES_CHOICE_SET = ['New', 'Limited', 'Special', 'Authentic', 'Signature', 'Retro', 'Standard-2018', 'Standard', 'Performing', '17', '16', '15', 'Road', 'X', 'Little', 'Junior', 'Ukulele', 'Backpacker', 'FSC', 'Discontinued']
    const SIMPLIFIED_BODY_SIZE_CHOICE_SET = [ 'Grand J', 'J', 'D', 'M (0000)', 'Grand Performance', '000', '00', '0', 'D Jr', 'M (0)', 'Backpacker', 'Ukulele']

    function arrayToSet(a) {
      let r = {}
      for (i = 0; i < a.length; ++i) {
        r[a[i]] = null
      }
      return r
    }
    function resetSelections() {
      selected_by_attr["Series"] = arrayToSet(SERIES_CHOICE_SET)
      delete selected_by_attr["Series"].Discontinued
      selected_by_attr["Simplified Body Size"] = arrayToSet(SIMPLIFIED_BODY_SIZE_CHOICE_SET)
    }

    let selected_by_attr = {}
    selected_by_attr["Product Group"] = 0
    resetSelections()
    let stat_by_attr = {}

    const product_group_field_ix = guitarDbFields.indexOf("Product Group")
    const series_field_ix = guitarDbFields.indexOf("Series")
    const simplified_body_size_field_ix = guitarDbFields.indexOf("Simplified Body Size")

    function incrementStat(choice_key, choice_val) {
      if (!(choice_key in stat_by_attr))
        stat_by_attr[choice_key] = {}
      let vals = stat_by_attr[choice_key]
      if (!(choice_val in vals))
        vals[choice_val] = 0
      ++vals[choice_val]
    }

    function removeChildNodesById(id) {
      const node = document.getElementById(id)
      const cNode = node.cloneNode(false);
      node.parentNode.replaceChild(cNode, node);
      return cNode
    }

    function renderTable() {
      const table = document.createElement('TABLE')
      const selected_product_group = PRODUCT_GROUP_CHOICE_SET[selected_by_attr["Product Group"]]

      stat_by_attr = {}
      stat_by_attr.count = 0

      for (i = 0; i < guitarDb.length; ++i) {
        const tr = document.createElement('TR')
        const gi = guitarDb[i]
        const product_group = gi[product_group_field_ix]
        const series = gi[series_field_ix]
        const simplified_body_size = gi[simplified_body_size_field_ix]

        if (product_group != selected_product_group) {
          continue
        }

        ++stat_by_attr.count
        incrementStat("Series", series)
        incrementStat("Simplified Body Size", simplified_body_size)

        const series_sel = selected_by_attr["Series"]
        if (!(series in series_sel)) {
          continue
        }

        const simplified_body_size_sel = selected_by_attr["Simplified Body Size"]
        if (!(simplified_body_size in simplified_body_size_sel)) {
          continue
        }

        {
          const td = document.createElement('TD')
          const innertable = document.createElement('TABLE')
          const tr0 = document.createElement('TR')
          const tr1 = document.createElement('TR')
          const tr2 = document.createElement('TR')

          {
            let img = document.createElement('IMG')
            img.src = "res/imgs_table_horiz/" + gi[3]
            let a = document.createElement('A')
            a.href = gi[2]
            a.appendChild(img)
            const tdq = document.createElement('TD')
            tdq.appendChild(a)
            tr0.appendChild(tdq)
            tr0.style = "text-align:center"
          }

          {
            let a = document.createElement('A')
            a.href = gi[2]
            a.innerText = gi[0]
            tr1.style = "text-align:center"
            tr1.appendChild(a)
          }

          tr2.appendChild(document.createTextNode(gi[4]))
          tr2.style = "text-align:center"

          innertable.appendChild(tr0)
          innertable.appendChild(tr1)
          innertable.appendChild(tr2)
          td.appendChild(innertable)
          tr.appendChild(td)
        }
        for (j = 0; j < tableFieldToDbIndices.length; j++) {
          const td = document.createElement('TD')
          const ix = tableFieldToDbIndices[j]
          td.appendChild(document.createTextNode(gi[ix]))
          tr.appendChild(td)
        }
        table.appendChild(tr)
      }

      let node = removeChildNodesById('div_data_display')
      node.appendChild(table)
    }

    function resetChoiceNode(nodeName) {
      const node = document.getElementById(nodeName)
      while (node.childNodes.length > 2) {
        node.removeChild(node.lastChild)
      }
      return node
    }

    function updateSelectors() {
      {
        const node = resetChoiceNode('tr_productGroupChoice')
        const c = selected_by_attr["Product Group"]
        for (let i = 0; i < PRODUCT_GROUP_CHOICE_SET.length; ++i) {
          const s = document.createElement('SPAN')
          s.appendChild(document.createTextNode(PRODUCT_GROUP_CHOICE_SET[i]))
          s.className = i == c ? "activeChoice" : "choice"
          s.onclick = function() { choiceClicked("Product Group", i) }
          const td = document.createElement('TD')
          td.appendChild(s)
          node.appendChild(td)
        }
      }
      function addChoiceList(id, choice_key, choice_set) {
        const node = resetChoiceNode(id)
        const selected_choice_vals = selected_by_attr[choice_key]
        let choice_count = 0
        for (let i = 0; i < choice_set.length; ++i) {
          const choice_val = choice_set[i]
          count = stat_by_attr[choice_key][choice_val]
          if (count != undefined || count > 0) {
            const s = document.createElement('SPAN')
            s.appendChild(document.createTextNode(choice_val))
            s.className = choice_val in selected_choice_vals
              ? "activeChoice" : "choice"
            s.onclick = function() { choiceClicked(choice_key, choice_val) }
            const td = document.createElement('TD')
            td.appendChild(s)
            node.appendChild(td)
            ++choice_count
          }
        }
        node.style.visibility = choice_count <= 1 ? "hidden" : "visible"
      }

      addChoiceList('tr_seriesChoice', "Series", SERIES_CHOICE_SET)
      addChoiceList('tr_simplifiedBodySizeChoice', "Simplified Body Size", SIMPLIFIED_BODY_SIZE_CHOICE_SET)
    }

    // x is either an index (for "Product Group") or
    // a choice value
    function choiceClicked(choice_key, x) {
      if (choice_key == "Product Group") {
        if (selected_by_attr[choice_key] != x) {
          selected_by_attr[choice_key] = x
          resetSelections()
          renderTable()
          updateSelectors()
        }
      } else {
        selected_choice_vals = selected_by_attr[choice_key]
        if (x in selected_choice_vals) {
          // Unselect.
          delete selected_choice_vals[x]
        } else {
          // Select
          selected_choice_vals[x] = null
        }
        renderTable()
        updateSelectors()
      }
    }
  </script>
  <script>
    renderTable()
    updateSelectors()
  </script>
</body>
</html>
